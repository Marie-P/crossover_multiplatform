import Model from"./model.min.js";import Character from"./utils/character.min.js";import View from"./view.min.js";export default class Controller{constructor(){this.model=new Model,this.view=new View(this.model.nbPlayers),this.charactersNames=["luffy","pikachu","naruto","Valider.","Retour au menu principal."],this.charactersUrls=["./assets/menu/luffy_choix.png","./assets/menu/pikachu_choix.png","./assets/menu/naruto_choix.png"],this.selectionMenu=[this.validate,this.backToMainMenu]}mainMenu(){let e=document.createElement("div"),t=document.createElement("p");e.className="mainMenu",t.innerHTML="Bienvenue dans notre crossover !<br><br>Choisissez une option : ",e.appendChild(t);let a=["1 Joueur","2 Joueurs"],s=["",""],i=[this.onePlayer,this.twoPlayers];for(let t=0;t<2;t++){let h=this.addButton(a[t],s[t],i[t]);e.appendChild(h)}document.body.appendChild(e)}addButton(e,t,a){let s=document.createElement("button"),i=document.createTextNode(e);if(t){let e=new Image;e.src=t,s.appendChild(e)}else s.appendChild(i);return a==this.getCharacter1||a==this.getCharacter2?s.addEventListener("click",a.bind(this,i)):s.addEventListener("click",a.bind(this)),s}clean(){for(;document.body.childNodes.length;)document.body.removeChild(document.body.firstChild)}backToMainMenu(){this.clean(),this.stop(),this.mainMenu()}getCharacter1(e){this.model.choosenFirstCharacter=e.nodeValue}getCharacter2(e){this.model.choosenSecondCharacter=e.nodeValue}addCharactersButtons(e,t){let a=document.createElement("div");a.appendChild(e);for(let e=0;e<3;e++){let s=this.addButton(this.charactersNames[e],this.charactersUrls[e],t);a.appendChild(s)}document.body.appendChild(a)}addSelectionButtons(){let e=document.createElement("div");for(let t=0;t<2;t++){let a=this.addButton(this.charactersNames[t+3],"",this.selectionMenu[t]);a.style.width="400px",a.style.height="70px",e.appendChild(a)}document.body.appendChild(e)}onePlayer(){this.clean(),this.model.nbPlayers=1;let e=document.createElement("p");e.innerHTML="Joueur 1 : ",this.addCharactersButtons(e,this.getCharacter1),this.addSelectionButtons()}twoPlayers(){this.clean(),this.model.nbPlayers=2;let e=document.createElement("p"),t=document.createElement("p");e.innerHTML="Joueur 1 : ",t.innerHTML="Joueur 2 : ",this.addCharactersButtons(e,this.getCharacter1),this.addCharactersButtons(t,this.getCharacter2),this.addSelectionButtons()}validate(){this.clean();let e=this.addButton("","./assets/menu/arrow_left.png",this.backToMainMenu);this.view.camera1=0,e.style.width="70px",e.style.height="35px",e.style.padding="0px",document.body.appendChild(e),this.load()}async load(){await this.initMap(),await this.initCharacters(),document.body.appendChild(this.view.canvas),2==this.model.nbPlayers&&document.body.appendChild(this.view.canvas2),this.start()}start(){this.loopPointer=window.requestAnimationFrame(e=>this.loop(e))}stop(){window.cancelAnimationFrame(this.loopPointer)}loop(e){this.loopPointer=window.requestAnimationFrame(e=>this.loop(e)),this.view.draw(this.model),this.checking1(this.model.map.tilemap,this.view.canvas),2==this.model.nbPlayers&&this.checking2(this.model.map.tilemap2,this.view.canvas2)}checking1(e,t){this.model.character1.posX>46&&(e[13*t.width+380]=162,this.model.character1.win()),"jump"==this.model.character1.move&&this.model.character1.jump(),this.model.character1.posX>20&&this.view.camera1<335&&(this.view.camera1+=1,this.model.character1.posX-=.5),this.model.map.spritesSupport.includes(this.model.map.tilemap[(this.model.character1.posY+2)*this.view.canvas.width+Math.round(this.model.character1.posX+this.view.camera1)+1])||(this.model.character1.move="fall",this.model.character1.fall()),this.model.character1.posY>this.model.map.mapHeight&&(this.model.character1.posX=0,this.view.camera1=0,this.model.character1.posY=12,this.model.character1.move="stand"),"fall"==this.model.character1.move&&(this.model.character1.posY>this.model.map.mapHeight||this.model.map.spritesSupport.includes(this.model.map.tilemap[(this.model.character1.posY+2)*this.view.canvas.width+Math.round(this.model.character1.posX+this.view.camera1)+1]))&&(this.model.character1.move="stand")}checking2(e,t){this.model.character2.posX>46&&(e[13*t.width+380]=162,this.model.character2.win()),"jump"==this.model.character2.move&&this.model.character2.jump(),this.model.character2.posX>20&&this.view.camera2<335&&(this.view.camera2+=1,this.model.character2.posX-=.5),this.model.map.spritesSupport.includes(this.model.map.tilemap2[(this.model.character2.posY+2)*this.view.canvas.width+Math.round(this.model.character2.posX+this.view.camera2)+1])||(this.model.character2.move="fall",this.model.character2.fall()),this.model.character2.posY>this.model.map.mapHeight&&(this.model.character2.posX=0,this.view.camera2=0,this.model.character2.posY=12,this.model.character2.move="stand"),"fall"==this.model.character2.move&&(this.model.character2.posY>this.model.map.mapHeight||this.model.map.spritesSupport.includes(this.model.map.tilemap2[(this.model.character2.posY+2)*this.view.canvas.width+Math.round(this.model.character2.posX+this.view.camera2)+1]))&&(this.model.character2.move="stand")}async initMap(){await this.model.setMap(),this.proceduralGeneration()}async initCharacters(){let e=await fetch("./assets/atlas/"+this.model.choosenFirstCharacter+".json"),t=await e.json(),a=await this.model.pic("./assets/atlas/"+t.meta.image);this.setCharacter(t,a,1),2==this.model.nbPlayers&&(e=await fetch("./assets/atlas/"+this.model.choosenSecondCharacter+".json"),t=await e.json(),a=await this.model.pic("./assets/atlas/"+t.meta.image),this.setCharacter(t,a,2))}proceduralGeneration(){this.initSprite(this.view.context),this.setBackground(Math.floor(3*Math.random()),this.view.canvas,this.model.map.tilemap),this.setCourse(this.view.canvas,this.model.map.tilemap),2==this.model.nbPlayers&&(this.initSprite(this.view.context2),this.setBackground(Math.floor(3*Math.random()),this.view.canvas2,this.model.map.tilemap2),this.setCourse(this.view.canvas2,this.model.map.tilemap2))}initSprite(e){e.drawImage(this.model.map.tileset,0,0,this.model.map.tileset.width,this.model.map.tileset.height);for(let t=0;t<this.model.map.tileset.height/this.model.map.tilesHeight;t++)for(let a=0;a<this.model.map.tileset.width/this.model.map.tilesWidth;a++)this.model.map.sprites.push(e.getImageData(a*this.model.map.tilesWidth,t*this.model.map.tilesHeight,this.model.map.tilesWidth,this.model.map.tilesHeight))}setBackground(e,t,a){let s=0==e?[30,29,70,69]:1==e?[110,109,150,149]:2==e?[190,189,230,229]:[];for(let e=0;e+1<this.model.map.sizeHeight;e+=2)for(let i=0;i+1<this.model.map.sizeWidth;i+=2)a[e*t.width+i]=s[0],a[e*t.width+(i+1)]=s[1],a[(e+1)*t.width+i]=s[2],a[(e+1)*t.width+(i+1)]=s[3];a[13*t.width+380]=161}setCourse(e,t){let a=this.model.map.spritesSupport[Math.floor(Math.random()*this.model.map.spritesSupport.length)];for(let s=0;s<this.model.map.sizeWidth;s++){let i=s+5;if(1==Math.floor(2*Math.random())||s<5||s>375)for(s-=1;s<i;s++)t[14*e.width+s]=a;else for(s-=1;s<i;s++)t[9*e.width+s]=a}}setCharacter(e,t,a){1==a?(this.model.character1=new Character(e,t,this.model.choosenFirstCharacter,0,this.lastSprites(this.model.choosenFirstCharacter)),this.setSprites(this.model.character1,this.model.choosenFirstCharacter)):2==a&&(this.model.character2=new Character(e,t,this.model.choosenSecondCharacter,0,this.lastSprites(this.model.choosenSecondCharacter)),this.setSprites(this.model.character2,this.model.choosenSecondCharacter))}setSprites(e){e.posX=0,e.posY=12,this.addSprites(e,e.name,"walk",e.lastSprites.walk),this.addSprites(e,e.name,"stand",e.lastSprites.stand),this.addSprites(e,e.name,"run",e.lastSprites.run),this.addSprites(e,e.name,"fall",e.lastSprites.fall),this.addSprites(e,e.name,"jump",e.lastSprites.jump),this.addSprites(e,e.name,"win",e.lastSprites.win)}addSprites(e,t,a,s){e.addSprites(a,s,t+"_"+a,this.setPosX(e.name,a),this.setPosY(e.name,a))}lastSprites(e){return"pikachu"==e?{walk:5,stand:1,fall:1,run:5,jump:7,win:10}:"naruto"==e?{walk:6,stand:1,fall:1,run:10,jump:7,win:15}:"luffy"==e?{walk:5,stand:1,fall:1,run:8,jump:6,win:8}:void 0}setPosX(e,t){return"pikachu"==e?"walk"==t?[.1,.1,.1,.6,.1]:"run"==t?.5:1:"naruto"==e?"walk"==t?[.6,.1,.1,.2,.1,.1]:"run"==t?.5:1:"luffy"==e?"walk"==t?[.1,1,.1,.1,1]:"run"==t?.5:1:void 0}setPosY(e,t){return"pikachu"==e?"walk"==t?[0,-.1,0,-.2,0]:"run"==t?.3:"jump"==t?[-.7,-.7,-10,-10,-10,-7,-5]:"win"==t?-.4:0:"naruto"==e?"walk"==t?-1.8:"run"==t?-1:"jump"==t?[-.7,-.7,-10,-10,-10,-7,-5]:"win"==t?[-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-1,-1,-1]:-1.6:"luffy"==e?"walk"==t?-2:"run"==t?-1.3:"jump"==t?[-1.8,-1.8,-7,-7,-7,-10]:-1.8:void 0}keydownFunction(e){switch(e.code){case"ArrowRight":this.arrowRightMovement(this.model.character1),this.model.pressed=!0;break;case"ArrowUp":this.arrowUpMovement(this.model.character1);break;case"KeyW":this.arrowUpMovement(this.model.character2);break;case"KeyS":"fall"!=this.model.character2.move&&"jump"!=this.model.character2.move&&"win"!=this.model.character2.move&&this.model.character2.walk();break;case"KeyD":"fall"!=this.model.character2.move&&"jump"!=this.model.character2.move&&"win"!=this.model.character2.move&&this.model.character2.run()}}keyupFunction(e){switch(e.code){case"ArrowRight":this.model.pressed=!1,"fall"!=this.model.character1.move&&"jump"!=this.model.character1.move&&"win"!=this.model.character1.move&&"walk"!=this.model.character1.move&&this.model.character1.stand()}}arrowRightMovement(e){"fall"!=e.move&&"jump"!=e.move&&"win"!=e.move&&(this.model.pressed?e.run():e.walk())}arrowUpMovement(e){e.state=0,e.jump()}}