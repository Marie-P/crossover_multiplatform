import Model from"./model.min.js";import Character from"./utils/character.min.js";import View from"./view.min.js";export default class Controller{constructor(){this.model=new Model,this.view=new View(this.model.nbPlayers),this.charactersNames=["luffy","pikachu","naruto","Valider.","Retour au menu principal."],this.charactersUrls=["./assets/menu/luffy_choix.png","./assets/menu/pikachu_choix.png","./assets/menu/naruto_choix.png"],this.selectionMenu=[this.validate,this.backToMainMenu]}mainMenu(){let t=document.createElement("div"),e=document.createElement("p");t.className="mainMenu",e.innerHTML="Bienvenue dans notre crossover !<br><br>Choisissez une option : ",t.appendChild(e);let a=["1 Joueur","2 Joueurs"],i=["",""],s=[this.onePlayer,this.twoPlayers];for(let e=0;e<2;e++){let h=this.addButton(a[e],i[e],s[e]);t.appendChild(h)}document.body.appendChild(t)}addButton(t,e,a){let i=document.createElement("button"),s=document.createTextNode(t);if(e){let t=new Image;t.src=e,i.appendChild(t)}else i.appendChild(s);return a==this.getCharacter1||a==this.getCharacter2?i.addEventListener("click",a.bind(this,s)):i.addEventListener("click",a.bind(this)),i}clean(){for(;document.body.childNodes.length;)document.body.removeChild(document.body.firstChild)}backToMainMenu(){this.clean(),this.stop(),this.mainMenu()}getCharacter1(t){this.model.choosenFirstCharacter=t.nodeValue}getCharacter2(t){this.model.choosenSecondCharacter=t.nodeValue}addCharactersButtons(t,e){let a=document.createElement("div");a.appendChild(t);for(let t=0;t<3;t++){let i=this.addButton(this.charactersNames[t],this.charactersUrls[t],e);a.appendChild(i)}document.body.appendChild(a)}addSelectionButtons(){let t=document.createElement("div");for(let e=0;e<2;e++){let a=this.addButton(this.charactersNames[e+3],"",this.selectionMenu[e]);a.style.width="400px",a.style.height="70px",t.appendChild(a)}document.body.appendChild(t)}onePlayer(){this.clean(),this.model.nbPlayers=1;let t=document.createElement("p");t.innerHTML="Joueur 1 : ",this.addCharactersButtons(t,this.getCharacter1),this.addSelectionButtons()}twoPlayers(){this.clean(),this.model.nbPlayers=2;let t=document.createElement("p"),e=document.createElement("p");t.innerHTML="Joueur 1 : ",e.innerHTML="Joueur 2 : ",this.addCharactersButtons(t,this.getCharacter1),this.addCharactersButtons(e,this.getCharacter2),this.addSelectionButtons()}validate(){this.clean();let t=this.addButton("","./assets/menu/arrow_left.png",this.backToMainMenu);this.view.camera1=0,t.style.width="70px",t.style.height="35px",t.style.padding="0px",document.body.appendChild(t),this.load()}async load(){await this.initMap(),await this.initCharacters(),document.body.appendChild(this.view.canvas),2==this.model.nbPlayers&&document.body.appendChild(this.view.canvas2);let t=document.createElement("div");this.walkButton=document.createElement("button");let e=document.createElement("p");e.innerHTML="marcher",e.style.fontSize="20px",this.walkButton.style.height="50px",this.walkButton.style.width="90px",this.walkButton.appendChild(e),this.walkButton.addEventListener("click",t=>this.walk(this.model.character1)),t.appendChild(this.walkButton),this.runButton=document.createElement("button");let a=document.createElement("p");a.innerHTML="courir",a.style.fontSize="20px",this.runButton.style.height="50px",this.runButton.style.width="80px",this.runButton.appendChild(a),this.runButton.addEventListener("touchstart",t=>this.run(this.model.character1)),this.runButton.addEventListener("touchend",t=>this.arrowRightMovementStop()),t.appendChild(this.runButton),this.jumpButton=document.createElement("button");let i=document.createElement("p");i.innerHTML="sauter",i.style.fontSize="20px",this.jumpButton.style.height="50px",this.jumpButton.style.width="80px",this.jumpButton.appendChild(i),this.jumpButton.addEventListener("click",t=>this.jump(this.model.character1)),t.appendChild(this.jumpButton),document.body.appendChild(t),this.start()}walk(t){t.walk()}run(t){this.model.run=!0}jump(t){t.jump()}start(){this.loopPointer=window.requestAnimationFrame(t=>this.loop(t))}stop(){window.cancelAnimationFrame(this.loopPointer)}loop(t){this.loopPointer=window.requestAnimationFrame(t=>this.loop(t)),this.view.draw(this.model),this.checking1(this.model.map.tilemap,this.view.canvas),2==this.model.nbPlayers&&this.checking2(this.model.map.tilemap2,this.view.canvas2),this.model.run&&this.model.character1.run()}checking1(t,e){let a=20;document.body.clientWidth<400&&(a=5),this.model.character1.posX>46&&(t[13*e.width+380]=162,this.model.character1.win()),"jump"==this.model.character1.move&&this.model.character1.jump(),this.model.character1.posX>a&&this.view.camera1<335&&(this.view.camera1+=1,this.model.character1.posX-=.5),this.model.map.spritesSupport.includes(this.model.map.tilemap[(this.model.character1.posY+2)*this.view.canvas.width+Math.round(this.model.character1.posX+this.view.camera1)+1])||(this.model.character1.move="fall",this.model.character1.fall()),this.model.character1.posY>this.model.map.mapHeight&&(this.model.character1.posX=0,this.view.camera1=0,this.model.character1.posY=12,this.model.character1.move="stand"),"fall"==this.model.character1.move&&(this.model.character1.posY>this.model.map.mapHeight||this.model.map.spritesSupport.includes(this.model.map.tilemap[(this.model.character1.posY+2)*this.view.canvas.width+Math.round(this.model.character1.posX+this.view.camera1)+1]))&&(this.model.character1.move="stand")}checking2(t,e){this.model.character2.posX>46&&(t[13*e.width+380]=162,this.model.character2.win()),"jump"==this.model.character2.move&&this.model.character2.jump(),this.model.character2.posX>20&&this.view.camera2<335&&(this.view.camera2+=1,this.model.character2.posX-=.5),this.model.map.spritesSupport.includes(this.model.map.tilemap2[(this.model.character2.posY+2)*this.view.canvas.width+Math.round(this.model.character2.posX+this.view.camera2)+1])||(this.model.character2.move="fall",this.model.character2.fall()),this.model.character2.posY>this.model.map.mapHeight&&(this.model.character2.posX=0,this.view.camera2=0,this.model.character2.posY=12,this.model.character2.move="stand"),"fall"==this.model.character2.move&&(this.model.character2.posY>this.model.map.mapHeight||this.model.map.spritesSupport.includes(this.model.map.tilemap2[(this.model.character2.posY+2)*this.view.canvas.width+Math.round(this.model.character2.posX+this.view.camera2)+1]))&&(this.model.character2.move="stand")}async initMap(){await this.model.setMap(),this.proceduralGeneration()}async initCharacters(){let t=await fetch("./assets/atlas/"+this.model.choosenFirstCharacter+".json"),e=await t.json(),a=await this.model.pic("./assets/atlas/"+e.meta.image);this.setCharacter(e,a,1),2==this.model.nbPlayers&&(t=await fetch("./assets/atlas/"+this.model.choosenSecondCharacter+".json"),e=await t.json(),a=await this.model.pic("./assets/atlas/"+e.meta.image),this.setCharacter(e,a,2))}proceduralGeneration(){this.initSprite(this.view.context),this.setBackground(Math.floor(3*Math.random()),this.view.canvas,this.model.map.tilemap),this.setCourse(this.view.canvas,this.model.map.tilemap),2==this.model.nbPlayers&&(this.initSprite(this.view.context2),this.setBackground(Math.floor(3*Math.random()),this.view.canvas2,this.model.map.tilemap2),this.setCourse(this.view.canvas2,this.model.map.tilemap2))}initSprite(t){t.drawImage(this.model.map.tileset,0,0,this.model.map.tileset.width,this.model.map.tileset.height);for(let e=0;e<this.model.map.tileset.height/this.model.map.tilesHeight;e++)for(let a=0;a<this.model.map.tileset.width/this.model.map.tilesWidth;a++)this.model.map.sprites.push(t.getImageData(a*this.model.map.tilesWidth,e*this.model.map.tilesHeight,this.model.map.tilesWidth,this.model.map.tilesHeight))}setBackground(t,e,a){let i=0==t?[30,29,70,69]:1==t?[110,109,150,149]:2==t?[190,189,230,229]:[];for(let t=0;t+1<this.model.map.sizeHeight;t+=2)for(let s=0;s+1<this.model.map.sizeWidth;s+=2)a[t*e.width+s]=i[0],a[t*e.width+(s+1)]=i[1],a[(t+1)*e.width+s]=i[2],a[(t+1)*e.width+(s+1)]=i[3];a[13*e.width+380]=161}setCourse(t,e){let a=this.model.map.spritesSupport[Math.floor(Math.random()*this.model.map.spritesSupport.length)];for(let i=0;i<this.model.map.sizeWidth;i++){let s=i+5;if(1==Math.floor(2*Math.random())||i<5||i>375)for(i-=1;i<s;i++)e[14*t.width+i]=a;else for(i-=1;i<s;i++)e[9*t.width+i]=a}}setCharacter(t,e,a){1==a?(this.model.character1=new Character(t,e,this.model.choosenFirstCharacter,0,this.lastSprites(this.model.choosenFirstCharacter)),this.setSprites(this.model.character1,this.model.choosenFirstCharacter)):2==a&&(this.model.character2=new Character(t,e,this.model.choosenSecondCharacter,0,this.lastSprites(this.model.choosenSecondCharacter)),this.setSprites(this.model.character2,this.model.choosenSecondCharacter))}setSprites(t){t.posX=0,t.posY=12,this.addSprites(t,t.name,"walk",t.lastSprites.walk),this.addSprites(t,t.name,"stand",t.lastSprites.stand),this.addSprites(t,t.name,"run",t.lastSprites.run),this.addSprites(t,t.name,"fall",t.lastSprites.fall),this.addSprites(t,t.name,"jump",t.lastSprites.jump),this.addSprites(t,t.name,"win",t.lastSprites.win)}addSprites(t,e,a,i){t.addSprites(a,i,e+"_"+a,this.setPosX(t.name,a),this.setPosY(t.name,a))}lastSprites(t){return"pikachu"==t?{walk:5,stand:1,fall:1,run:5,jump:7,win:10}:"naruto"==t?{walk:6,stand:1,fall:1,run:10,jump:7,win:15}:"luffy"==t?{walk:5,stand:1,fall:1,run:8,jump:6,win:8}:void 0}setPosX(t,e){return"pikachu"==t?"walk"==e?[.1,.1,.1,.6,.1]:"run"==e?.5:1:"naruto"==t?"walk"==e?[.6,.1,.1,.2,.1,.1]:"run"==e?.5:1:"luffy"==t?"walk"==e?[.1,1,.1,.1,1]:"run"==e?.5:1:void 0}setPosY(t,e){return"pikachu"==t?"walk"==e?[0,-.1,0,-.2,0]:"run"==e?.3:"jump"==e?[-.7,-.7,-10,-10,-10,-7,-5]:"win"==e?-.4:0:"naruto"==t?"walk"==e?-1.8:"run"==e?-1:"jump"==e?[-.7,-.7,-10,-10,-10,-7,-5]:"win"==e?[-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-1,-1,-1]:-1.6:"luffy"==t?"walk"==e?-2:"run"==e?-1.3:"jump"==e?[-1.8,-1.8,-7,-7,-7,-10]:-1.8:void 0}keydownFunction(t){switch(t.code){case"ArrowRight":this.arrowRightMovement(this.model.character1);break;case"ArrowUp":this.arrowUpMovement(this.model.character1);break;case"KeyW":this.arrowUpMovement(this.model.character2);break;case"KeyS":"fall"!=this.model.character2.move&&"jump"!=this.model.character2.move&&"win"!=this.model.character2.move&&this.model.character2.walk();break;case"KeyD":"fall"!=this.model.character2.move&&"jump"!=this.model.character2.move&&"win"!=this.model.character2.move&&this.model.character2.run()}}keyupFunction(t){switch(t.code){case"ArrowRight":this.arrowRightMovementStop()}}arrowRightMovement(t){"fall"!=t.move&&"jump"!=t.move&&"win"!=t.move&&(this.model.pressed?t.run():(t.walk(),this.model.pressed=!0))}arrowRightMovementStop(){this.model.pressed=!1,this.model.run=!1,"fall"!=this.model.character1.move&&"jump"!=this.model.character1.move&&"win"!=this.model.character1.move&&"walk"!=this.model.character1.move&&this.model.character1.stand()}arrowUpMovement(t){t.state=0,t.jump()}}